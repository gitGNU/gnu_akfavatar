# Makefile template for AKFAvatar
# Copyright (C) 2007 Andreas K. Foerster
#
# This Makefile template is free software; you have unlimited permission
# to copy, distribute and modify it.

SHELL = /bin/sh
INSTALL_PROGRAM = $(INSTALL) -m 755
INSTALL_DATA = $(INSTALL) -m 644

# names for packages
PKGNAME = akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)
BINPKGNAME = akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).bin


.PHONY: all check doc txt info install install-strip installdirs uninstall \
	html dvi pdf ps man install-html install-dvi install-pdf install-ps \
	clean mostlyclean distclean maintainerclean dist

all: libakfavatar.so libakfavatar.a avatarsay avatarsay-d

# don't use $(CC) because it could be a cross-compiler
bin2c: bin2c.c
	cc -o $@ bin2c.c

gnu-head.c: gnu-head.bmp bin2c
	./bin2c avatar_image < gnu-head.bmp > $@

gnu-small.c: gnu-small.bmp bin2c
	./bin2c avatar_image < gnu-small.bmp > $@

bell.c: bell.wav bin2c
	./bin2c avt_bell_data < bell.wav > $@

avatar.o: avatar.c akfavatar.h version.h balloonpointer.c circle.c regicon.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c avatar.c

avatar-default.o: avatar-default.c gnu-head.c gnu-small.c akfavatar.h
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -o $@ avatar-default.c

avatar-audio.o: avatar-audio.c akfavatar.h bell.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -o $@ avatar-audio.c

font.o: font.c ucsfont7x14.c ucsfont4x6.c ucsfont9x18.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -o $@ font.c

libakfavatar.a: avatar.o avatar-default.o avatar-audio.o font.o
	$(AR) rcu $@ avatar.o avatar-default.o avatar-audio.o font.o
	-$(RANLIB) $@

avatar.lo: avatar.c akfavatar.h version.h balloonpointer.c circle.c regicon.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fpic -o $@ \
	  avatar.c

avatar-default.lo: avatar-default.c gnu-head.c gnu-small.c akfavatar.h
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fpic -o $@ avatar-default.c

avatar-audio.lo: avatar-audio.c akfavatar.h bell.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fpic -o $@ avatar-audio.c

font.lo: font.c ucsfont7x14.c ucsfont4x6.c ucsfont9x18.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fpic -o $@ font.c

libakfavatar.so: avatar.lo avatar-default.lo avatar-audio.lo font.lo
	$(CC) -shared \
	      -Wl,-soname,$(SONAME) -o $(LIBNAME) -fpic \
	      avatar.lo avatar-default.lo avatar-audio.lo font.lo \
	      $(LDFLAGS) $(SDLLDFLAGS)
	-ln -sf $(LIBNAME) $(SONAME)
	-ln -sf $(LIBNAME) libakfavatar.so

example: example.c libakfavatar.so
	$(CC) $(CFLAGS) -I. -o $@ example.c -L. -lakfavatar $(LDFLAGS)

# avatarsay dynamically linked
# only works, when the library is installed
avatarsay-d: avatarsay.c libakfavatar.so
	$(CC) $(CFLAGS) -I. -o $@ avatarsay.c -L. -lakfavatar $(LDFLAGS)

# avatarsay with statical libakfavatar.a
avatarsay: avatarsay.c libakfavatar.a
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -o $@ avatarsay.c libakfavatar.a \
	  $(LDFLAGS) $(SDLLDFLAGS)

installdirs:
	-[ -d $(DESTDIR)$(includedir) ]  || $(INSTALL) -d $(DESTDIR)$(includedir)
	-[ -d $(DESTDIR)$(libdir) ]      || $(INSTALL) -d $(DESTDIR)$(libdir)
	-[ -d $(DESTDIR)$(bindir) ]      || $(INSTALL) -d $(DESTDIR)$(bindir)
	-[ -d $(DESTDIR)$(infodir) ]     || $(INSTALL) -d $(DESTDIR)$(infodir)
	-[ -d $(DESTDIR)$(mandir) ]      || $(INSTALL) -d $(DESTDIR)$(mandir)
	-[ -d $(DESTDIR)$(mandir)/man1 ] || $(INSTALL) -d $(DESTDIR)$(mandir)/man1

install: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) $(srcdir)/akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(LIBNAME) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) $(srcdir)/avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/gnome-akfavatar $(DESTDIR)$(bindir)

install-strip: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) $(srcdir)/akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) -s $(LIBNAME) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) -s avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) $(srcdir)/avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/gnome-akfavatar $(DESTDIR)$(bindir)

uninstall: uninstall-info uninstall-man
	-rm -f $(includedir)/akfavatar.h
	-rm -f $(libdir)/$(LIBNAME)
	-rm -f $(libdir)/$(SONAME)
	-rm -f $(libdir)/libakfavatar.so
	-rm -f $(libdir)/libakfavatar.a
	-rm -f $(bindir)/avatarsay
	-rm -f $(bindir)/avtman
	-rm -f $(bindir)/gnome-akfavatar

info:
	$(MAKE) -C $(srcdir)/doc info

install-info: info
	$(INSTALL_DATA) $(srcdir)/doc/akfavatar-en.info $(DESTDIR)$(infodir)
	$(INSTALL_DATA) $(srcdir)/doc/akfavatar-de.info $(DESTDIR)$(infodir)
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-en.info 
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-de.info 

uninstall-info:
	-install-info --remove --info-dir=$(DESTDIR)$(infodir) \
	  $(DESTDIR)$(infodir)/akfavatar-en.info 
	-rm -f $(DESTDIR)$(infodir)/akfavatar-en.info

install-man:
	-$(INSTALL_DATA) $(srcdir)/doc/avatarsay.1 $(DESTDIR)$(mandir)/man1

uninstall-man:
	-rm -f $(DESTDIR)$(mandir)/man1/avatarsay.1

txt:
	$(MAKE) -C $(srcdir)/doc txt

html:
	$(MAKE) -C $(srcdir)/doc html

install-html:

dvi:
	$(MAKE) -C $(srcdir)/doc dvi

install-dvi:

pdf:
	$(MAKE) -C $(srcdir)/doc pdf

install-pdf:

ps:
	$(MAKE) -C $(srcdir)/doc ps

install-ps:

man:
	$(MAKE) -C $(srcdir)/doc man

doc:
	$(MAKE) -C $(srcdir)/doc all

check:

clean:
	-rm -f *~
	-rm -f *.o *.lo 
	-rm -f bin2c
	-rm -f gnu-head.c gnu-small.c bell.c
	-rm -f pascal/*.o pascal/*.gpi pascal/*.gpm pascal/*.ppu
	-rm -f pascal/link.res pascal/ppas.sh
	$(MAKE) -C $(srcdir)/mingw32 clean
	$(MAKE) -C $(srcdir)/doc clean

mostlyclean: clean

distclean: clean
	-rm -f avatarsay avatarsay-d example a.out *.a *.so
	-rm -f $(LIBNAME) $(SONAME)
	-rm -f config.status
	-rm -f version.h
	-rm -f Makefile
	-rm -f $(srcdir)/pascal/example
	-rm -f akfavatar-*.tar.gz
	-rm -f multiply-bin multiply
	-rm -f multiplizieren-bin multiplizieren
	$(MAKE) -C $(srcdir)/mingw32 distclean
	$(MAKE) -C $(srcdir)/doc distclean


# the rest is just for the maintainer
# don't use it unless you know what you are doing

maintainerclean: distclean

multiply: $(srcdir)/pascal/multiply.pas
	-fpcavatar -dRELEASE -FE. -o$@ $(srcdir)/pascal/multiply.pas -k-rpath=.

multiplizieren: $(srcdir)/pascal/multiply.pas
	-fpcavatar -dRELEASE -ddeutsch -FE. -o$@ $(srcdir)/pascal/multiply.pas \
	  -k-rpath=.

dist: info txt man distclean
	mkdir $(PKGNAME)
	ln README INSTALL AUTHORS COPYING ChangeLog lrun \
	   avatar.c akfavatar.h avatar-audio.c avatar-default.c \
	   balloonpointer.c circle.c regicon.c gnu-head.bmp \
	   avatarsay.c avtman example.c fsdemo-?? \
	   gnome-akfavatar bdfread.pas human-peasant.bmp \
	   gnu-small.bmp akfavatar.xpm bin2c.c \
	   ucsfont7x14.c ucsfont4x6.c ucsfont9x18.c font.c \
	   bell.wav configure Makefile.in \
	   $(PKGNAME)/
	
	mkdir $(PKGNAME)/pascal
	ln pascal/README pascal/akfavatar.pas pascal/example.pas \
	   pascal/multiply.pas pascal/correct.wav pascal/wrong.wav \
	   pascal/gpcavatar pascal/fpcavatar \
	   $(PKGNAME)/pascal/
	
	mkdir $(PKGNAME)/doc
	ln doc/README doc/Makefile doc/avatarsay.1 \
	   doc/akfavatar-en.texinfo doc/akfavatar-en.info \
	   doc/akfavatar-en.txt \
	   doc/akfavatar-de.texinfo doc/akfavatar-de.info \
	   doc/akfavatar-de.txt \
	   doc/akfavatar.css \
	   $(PKGNAME)/doc/
	
	mkdir $(PKGNAME)/mingw32
	ln mingw32/akfavatar.ico mingw32/icon.rc \
	   mingw32/Makefile mingw32/README \
	   mingw32/fsdemo-??.bat \
	   $(PKGNAME)/mingw32/
	
	tar -cvf $(PKGNAME).tar $(PKGNAME)/
	gzip -9 $(PKGNAME).tar
	rm -r $(PKGNAME)/

dist-bin: avatarsay multiply multiplizieren
	strip avatarsay
	mkdir $(BINPKGNAME)
	ln $(LIBNAME) $(SONAME) $(BINPKGNAME)/
	ln $(srcdir)/akfavatar.h $(srcdir)/pascal/akfavatar.pas $(BINPKGNAME)/
	ln $(srcdir)/pascal/?pcavatar $(BINPKGNAME)/
	-ln multiply $(BINPKGNAME)/
	-ln multiplizieren $(BINPKGNAME)/
	ln $(srcdir)/pascal/correct.wav $(srcdir)/pascal/wrong.wav \
	   $(BINPKGNAME)/
	ln $(srcdir)/COPYING $(srcdir)/AUTHORS avatarsay $(srcdir)/avtman \
	   $(srcdir)/fsdemo-?? \
	   $(srcdir)/gnome-akfavatar $(srcdir)/human-peasant.bmp \
	   $(BINPKGNAME)/
	tar -cvf $(BINPKGNAME).$(SYSTEM).$(ARCH).tar $(BINPKGNAME)/
	gzip -9 $(BINPKGNAME).$(SYSTEM).$(ARCH).tar
	rm -r $(BINPKGNAME)/
