# Makefile template for AKFAvatar
# Copyright (C) 2007, 2008 Andreas K. Foerster
#
# This Makefile template is free software; you have unlimited permission
# to copy, distribute and modify it.

SHELL = /bin/sh
INSTALL_PROGRAM = $(INSTALL) -m 755
INSTALL_DATA = $(INSTALL) -m 644

# names for packages
PKGNAME = akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)
BINPKGNAME = akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).bin


.PHONY: all check doc txt info install install-strip installdirs uninstall \
	html dvi pdf ps man install-html install-dvi install-pdf install-ps \
	clean mostlyclean distclean maintainer-clean maintainerclean dist

all: libakfavatar.so libakfavatar.a libavtcio.a avatarsay avatarsay-d

Makefile: $(srcdir)/configure $(srcdir)/Makefile.in
	./config.status

# don't use $(CC) because it could be a cross-compiler
bin2c: $(srcdir)/bin2c.c
	cc -o $@ $(srcdir)/bin2c.c

gnu-head.c: $(srcdir)/gnu-head.bmp bin2c
	./bin2c avatar_image < $(srcdir)/gnu-head.bmp > $@

gnu-small.c: $(srcdir)/gnu-small.bmp bin2c
	./bin2c avatar_image < $(srcdir)/gnu-small.bmp > $@

keybtn.c: $(srcdir)/keybtn.bmp bin2c
	./bin2c keybtn < $(srcdir)/keybtn.bmp > $@

bell.c: $(srcdir)/bell.wav bin2c
	./bin2c avt_bell_data < $(srcdir)/bell.wav > $@

avtfilechooser.o: $(srcdir)/avtfilechooser.c $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) $(SDLCFLAGS) -c -o $@ $(srcdir)/avtfilechooser.c

avatar.o: $(srcdir)/avatar.c $(srcdir)/akfavatar.h version.h \
	  $(srcdir)/balloonpointer.c $(srcdir)/circle.c \
	  keybtn.c $(srcdir)/regicon.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c $(srcdir)/avatar.c

avatar-default.o: $(srcdir)/avatar-default.c gnu-head.c gnu-small.c \
                  $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -o $@ $(srcdir)/avatar-default.c

avatar-audio.o: $(srcdir)/avatar-audio.c $(srcdir)/akfavatar.h bell.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -o $@ $(srcdir)/avatar-audio.c

font.o: $(srcdir)/font.c $(srcdir)/ucsfont7x14.c $(srcdir)/ucsfont4x6.c \
	$(srcdir)/ucsfont9x18.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -o $@ $(srcdir)/font.c

libakfavatar.a: avatar.o avatar-default.o avatar-audio.o font.o
	$(AR) rcu $@ avatar.o avatar-default.o avatar-audio.o font.o
	-$(RANLIB) $@

avatar.lo: $(srcdir)/avatar.c $(srcdir)/akfavatar.h version.h \
	   $(srcdir)/balloonpointer.c $(srcdir)/circle.c keybtn.c \
	   $(srcdir)/regicon.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fPIC -o $@ \
	  $(srcdir)/avatar.c

avatar-default.lo: $(srcdir)/avatar-default.c gnu-head.c gnu-small.c \
	           $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fPIC -o $@ \
	  $(srcdir)/avatar-default.c

avatar-audio.lo: $(srcdir)/avatar-audio.c $(srcdir)/akfavatar.h bell.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fPIC -o $@ \
	  $(srcdir)/avatar-audio.c

font.lo: $(srcdir)/font.c $(srcdir)/ucsfont7x14.c $(srcdir)/ucsfont4x6.c \
	 $(srcdir)/ucsfont9x18.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -I. -c -fPIC -o $@ $(srcdir)/font.c

libakfavatar.so: avatar.lo avatar-default.lo avatar-audio.lo font.lo
	$(CC) -shared \
	      -Wl,-soname,$(SONAME) -o $(LIBNAME) -fPIC \
	      avatar.lo avatar-default.lo avatar-audio.lo font.lo \
	      $(LDFLAGS) $(SDLLDFLAGS)
	-ln -sf $(LIBNAME) $(SONAME)
	-ln -sf $(LIBNAME) libakfavatar.so

avtccio.o: $(srcdir)/avtccio.c $(srcdir)/avtcio.h $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) -I. -c -o $@ $(srcdir)/avtccio.c

avtcwio.o: $(srcdir)/avtcwio.c $(srcdir)/avtcio.h $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) -I. -c -o $@ $(srcdir)/avtcwio.c

libavtcio.a: avtccio.o avtcwio.o
	$(AR) rcu $@ avtccio.o avtcwio.o
	-$(RANLIB) $@

example: $(srcdir)/example.c libakfavatar.so
	$(CC) $(CFLAGS) -I. -o $@ $(srcdir)/example.c \
	  -L. -lakfavatar $(LDFLAGS)

avatarsay.o: $(srcdir)/avatarsay.c $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) $(SDLCFLAGS) -DPREFIX=\"$(exec_prefix)\" -I. \
	  -c -o $@ $(srcdir)/avatarsay.c

# avatarsay dynamically linked
# only works, when the library is installed
avatarsay-d: avatarsay.o avtfilechooser.o libakfavatar.so
	$(CC) -o $@ avatarsay.o avtfilechooser.o -L. -lakfavatar $(LDFLAGS)

# avatarsay with statical libakfavatar.a
avatarsay: avatarsay.o avtfilechooser.o libakfavatar.a
	$(CC) -o $@ avatarsay.o libakfavatar.a avtfilechooser.o \
	  $(LDFLAGS) $(SDLLDFLAGS)

installdirs:
	-[ -d $(DESTDIR)$(includedir) ]  || $(INSTALL) -d $(DESTDIR)$(includedir)
	-[ -d $(DESTDIR)$(libdir) ]      || $(INSTALL) -d $(DESTDIR)$(libdir)
	-[ -d $(DESTDIR)$(bindir) ]      || $(INSTALL) -d $(DESTDIR)$(bindir)
	-[ -d $(DESTDIR)$(infodir) ]     || $(INSTALL) -d $(DESTDIR)$(infodir)
	-[ -d $(DESTDIR)$(mandir) ]      || $(INSTALL) -d $(DESTDIR)$(mandir)
	-[ -d $(DESTDIR)$(mandir)/man1 ] || $(INSTALL) -d $(DESTDIR)$(mandir)/man1

install: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) $(srcdir)/akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(srcdir)/avtcio.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(LIBNAME) $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libavtcio.a $(DESTDIR)$(libdir)
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) $(srcdir)/avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/gnome-akfavatar $(DESTDIR)$(bindir)

install-strip: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) $(srcdir)/akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(srcdir)/avtcio.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) -s $(LIBNAME) $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libavtcio.a $(DESTDIR)$(libdir)
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) -s avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) $(srcdir)/avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/gnome-akfavatar $(DESTDIR)$(bindir)

uninstall: uninstall-info uninstall-man
	-rm -f $(includedir)/akfavatar.h
	-rm -f $(includedir)/avtcio.h
	-rm -f $(libdir)/$(LIBNAME)
	-rm -f $(libdir)/$(SONAME)
	-rm -f $(libdir)/libakfavatar.so
	-rm -f $(libdir)/libakfavatar.a
	-rm -f $(libdir)/libavtcio.a
	-rm -f $(bindir)/avatarsay
	-rm -f $(bindir)/avtman
	-rm -f $(bindir)/gnome-akfavatar

info:
	$(MAKE) -C $(srcdir)/doc info

install-info: info
	$(INSTALL_DATA) $(srcdir)/doc/akfavatar-en.info $(DESTDIR)$(infodir)
	$(INSTALL_DATA) $(srcdir)/doc/akfavatar-de.info $(DESTDIR)$(infodir)
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-en.info 
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-de.info 

uninstall-info:
	-install-info --remove --info-dir=$(DESTDIR)$(infodir) \
	  $(DESTDIR)$(infodir)/akfavatar-en.info 
	-rm -f $(DESTDIR)$(infodir)/akfavatar-en.info
	-install-info --remove --info-dir=$(DESTDIR)$(infodir) \
	  $(DESTDIR)$(infodir)/akfavatar-de.info 
	-rm -f $(DESTDIR)$(infodir)/akfavatar-de.info

install-man: man
	-$(INSTALL_DATA) $(srcdir)/doc/avatarsay.1 $(DESTDIR)$(mandir)/man1

uninstall-man:
	-rm -f $(DESTDIR)$(mandir)/man1/avatarsay.1

txt:
	$(MAKE) -C $(srcdir)/doc txt

html:
	$(MAKE) -C $(srcdir)/doc html

install-html:

dvi:
	$(MAKE) -C $(srcdir)/doc dvi

install-dvi:

pdf:
	$(MAKE) -C $(srcdir)/doc pdf

install-pdf:

ps:
	$(MAKE) -C $(srcdir)/doc ps

install-ps:

man:
	$(MAKE) -C $(srcdir)/doc man

doc:
	$(MAKE) -C $(srcdir)/doc all

check:

clean:
	-rm -f *~
	-rm -f *.o *.lo
	-rm -f *.ppu *.gpi *.gpm
	-rm -f bin2c
	-rm -f gnu-head.c gnu-small.c bell.c keybtn.c
	-rm -f pascal/*.o pascal/*.gpi pascal/*.gpm pascal/*.ppu
	-rm -f pascal/link.res pascal/ppas.sh
	$(MAKE) -C $(srcdir)/mingw32 clean
	$(MAKE) -C $(srcdir)/doc clean

mostlyclean: clean

distclean: clean
	-rm -f avatarsay avatarsay-d example a.out *.a *.so
	-rm -f $(LIBNAME) $(SONAME)
	-rm -f config.status
	-rm -f version.h
	-rm -f Makefile
	-rm -f $(srcdir)/pascal/example
	-rm -f akfavatar-*.tar.gz
	-rm -f multiply-bin multiply
	-rm -f multiplizieren-bin multiplizieren
	$(MAKE) -C $(srcdir)/mingw32 distclean
	$(MAKE) -C $(srcdir)/doc distclean


# the rest is just for the maintainer
# don't use it unless you know what you are doing

maintainer-clean: distclean
	@echo 'This command is intended for maintainers to use; it'
	@echo 'deletes files that may need special tools to rebuild.'
	$(MAKE) -C $(srcdir)/doc maintainer-clean

maintainerclean: maintainer-clean

multiply: $(srcdir)/pascal/multiply.pas
	-$(srcdir)/pascal/fpcavatar -dRELEASE -FE. -o$@ \
	    $(srcdir)/pascal/multiply.pas -k-rpath=.

multiplizieren: $(srcdir)/pascal/multiply.pas
	-$(srcdir)/pascal/fpcavatar -dRELEASE -ddeutsch -FE. -o$@ \
	    $(srcdir)/pascal/multiply.pas -k-rpath=.

dist: info html man distclean
	mkdir $(PKGNAME)
	ln README INSTALL AUTHORS COPYING ChangeLog lrun \
	   avatar.c akfavatar.h avatar-audio.c avatar-default.c \
	   avtccio.c avtcwio.c avtcio.h avtfilechooser.c \
	   balloonpointer.c circle.c regicon.c gnu-head.bmp keybtn.bmp \
	   avatarsay.c avtman example.c fsdemo-?? \
	   gnome-akfavatar bdfread.pas \
	   gnu-small.bmp akfavatar.xpm bin2c.c \
	   ucsfont7x14.c ucsfont4x6.c ucsfont9x18.c font.c \
	   bell.wav configure Makefile.in \
	   $(PKGNAME)/
	
	mkdir $(PKGNAME)/pascal
	ln pascal/README pascal/akfavatar.pas pascal/example.pas \
	   pascal/multiply.pas pascal/correct.wav pascal/wrong.wav \
	   pascal/gpcavatar pascal/fpcavatar \
	   $(PKGNAME)/pascal/
	
	mkdir $(PKGNAME)/doc
	ln doc/README doc/Makefile doc/avatarsay.1 \
	   doc/akfavatar.h doc/pasref.txt \
	   doc/akfavatar-en.texinfo doc/akfavatar-en.info \
	   doc/akfavatar-en.html \
	   doc/akfavatar-de.texinfo doc/akfavatar-de.info \
	   doc/akfavatar-de.html \
	   doc/akfavatar.css \
	   doc/pdfmeta-en doc/pdfmeta-de \
	   $(PKGNAME)/doc/
	
	mkdir $(PKGNAME)/mingw32
	ln mingw32/akfavatar.ico mingw32/icon.rc \
	   mingw32/Makefile mingw32/README \
	   mingw32/fsdemo-??.bat \
	   $(PKGNAME)/mingw32/
	
	tar -cvf $(PKGNAME).tar $(PKGNAME)/
	bzip2 $(PKGNAME).tar
	rm -rf $(PKGNAME)/

dist-bin: avatarsay multiply multiplizieren info html
	mkdir $(BINPKGNAME)
	cp $(LIBNAME) $(BINPKGNAME)/
	cp avatarsay $(BINPKGNAME)/
	ln $(SONAME) $(BINPKGNAME)/
	ln $(srcdir)/akfavatar.h $(srcdir)/pascal/akfavatar.pas $(BINPKGNAME)/
	ln $(srcdir)/pascal/?pcavatar $(BINPKGNAME)/
	-ln multiply $(BINPKGNAME)/
	-ln multiplizieren $(BINPKGNAME)/
	ln $(srcdir)/pascal/correct.wav $(srcdir)/pascal/wrong.wav \
	   $(BINPKGNAME)/
	ln $(srcdir)/COPYING $(srcdir)/AUTHORS $(srcdir)/avtman \
	   $(srcdir)/fsdemo-?? \
	   $(srcdir)/gnome-akfavatar \
	   $(BINPKGNAME)/
	ln $(srcdir)/doc/akfavatar-??.html $(BINPKGNAME)/
	ln $(srcdir)/doc/akfavatar-??.info $(BINPKGNAME)/
	strip $(BINPKGNAME)/avatarsay
	strip $(BINPKGNAME)/$(LIBNAME)
	tar -cvf $(BINPKGNAME).$(SYSTEM).$(ARCH).tar $(BINPKGNAME)/
	bzip2 $(BINPKGNAME).$(SYSTEM).$(ARCH).tar
	rm -rf $(BINPKGNAME)/
