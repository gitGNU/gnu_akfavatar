# Makefile template for AKFAvatar
# Copyright (C) 2007, 2008, 2009 Andreas K. Foerster
#
# This Makefile template is free software; you have unlimited permission
# to copy, distribute and modify it.

# if you change this, you also have to change the file avatar-default.c
default_avatar = $(srcdir)/male_user.xpm

SHELL = /bin/sh
INSTALL_PROGRAM = $(INSTALL) -m 755
INSTALL_DATA = $(INSTALL) -m 644

SOX = sox

# Soundfile for the bell (\a)
# may be any format that sox supports
# should be higher quality; it will be converted into the needed format
BELL = $(srcdir)/bell.flac 

# names for packages
PKGNAME = akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)
BINPKGNAME = akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).bin


.PHONY: all check doc txt info install install-strip installdirs uninstall \
	html dvi pdf ps man install-html install-dvi install-pdf install-ps \
	clean mostlyclean distclean maintainer-clean maintainerclean dist \
	mingw

all: libakfavatar.so libakfavatar.a libavtaddons.a avatarsay avatarsay-d
	@echo '*'
	@echo '* use "make install" or "make install-strip"'
	@echo '* with root-privileges to install it.'
	@echo '*'

mingw:
	$(MAKE) -C $(srcdir)/mingw all

Makefile: $(srcdir)/configure $(srcdir)/Makefile.in
	./config.status

# local tool: don't use $(CC) because it could be a cross-compiler
bin2c: $(srcdir)/bin2c.c
	cc -o $@ $(srcdir)/bin2c.c

# local tool: don't use $(CC) because it could be a cross-compiler
bdfread: $(srcdir)/bdfread.c
	cc -o $@ $(srcdir)/bdfread.c

# bell.au should be in the sourcecode-distribution
$(srcdir)/bell.au: $(srcdir)/bell.flac
	@echo "create headerless old AU file"
	$(SOX) $(BELL) --type .ul --channels 1 $@ rate -l 8k

bell.c: $(srcdir)/bell.au bin2c
	./bin2c avt_bell_data < $(srcdir)/bell.au > $@

avtfilechooser.o: $(srcdir)/avtfilechooser.c $(srcdir)/akfavatar.h
	$(CC) $(SDLCFLAGS) $(CFLAGS) -c -o $@ $(srcdir)/avtfilechooser.c

avatar.o: $(srcdir)/avatar.c $(srcdir)/akfavatar.h version.h avtcolors.h \
	  $(srcdir)/balloonpointer.xpm $(srcdir)/circle.xpm \
	  $(srcdir)/btn-cont.xpm $(srcdir)/akfavatar.xpm
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c $(srcdir)/avatar.c

avatar-default.o: $(srcdir)/avatar-default.c $(default_avatar) $(srcdir)/akfavatar.h
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -o $@ $(srcdir)/avatar-default.c

avatar-audio.o: $(srcdir)/avatar-audio.c $(srcdir)/akfavatar.h bell.c
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -o $@ $(srcdir)/avatar-audio.c

ucsfont7x14.c: $(srcdir)/7x14.bdf bdfread
	./bdfread $(srcdir)/7x14.bdf > $@

ucsfont9x18.c: $(srcdir)/9x18.bdf bdfread
	./bdfread $(srcdir)/9x18.bdf > $@

font.o: $(srcdir)/font.c ucsfont7x14.c ucsfont9x18.c
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -o $@ $(srcdir)/font.c

libakfavatar.a: avatar.o avatar-default.o avatar-audio.o font.o
	$(AR) rcu $@ avatar.o avatar-default.o avatar-audio.o font.o
	-$(RANLIB) $@

avatar.lo: $(srcdir)/avatar.c $(srcdir)/akfavatar.h version.h avtcolors.h \
	   $(srcdir)/balloonpointer.xpm $(srcdir)/circle.xpm \
	   $(srcdir)/btn-cont.xpm $(srcdir)/akfavatar.xpm
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -fPIC -o $@ \
	  $(srcdir)/avatar.c

avatar-default.lo: $(srcdir)/avatar-default.c $(default_avatar) $(srcdir)/akfavatar.h
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -fPIC -o $@ \
	  $(srcdir)/avatar-default.c

avatar-audio.lo: $(srcdir)/avatar-audio.c $(srcdir)/akfavatar.h bell.c
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -fPIC -o $@ \
	  $(srcdir)/avatar-audio.c

font.lo: $(srcdir)/font.c ucsfont7x14.c ucsfont9x18.c
	$(CC) $(SDLCFLAGS) $(CFLAGS) -I. -c -fPIC -o $@ $(srcdir)/font.c

libakfavatar.so: avatar.lo avatar-default.lo avatar-audio.lo font.lo
	$(CC) -shared \
	      -Wl,-soname,$(SONAME) -o $(LIBNAME) -fPIC \
	      avatar.lo avatar-default.lo avatar-audio.lo font.lo \
	      $(SDLLDFLAGS) $(LDFLAGS)
	-ln -sf $(LIBNAME) $(SONAME)
	-ln -sf $(LIBNAME) libakfavatar.so

example: $(srcdir)/example.c libakfavatar.so
	$(CC) $(CFLAGS) -I. -o $@ $(srcdir)/example.c \
	  -L. -lakfavatar $(LDFLAGS) $(LOCAL_GCC_RPATH)

avtccio.o: $(srcdir)/avtccio.c $(srcdir)/avtcio.h $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) -I. -c -o $@ $(srcdir)/avtccio.c

avtcwio.o: $(srcdir)/avtcwio.c $(srcdir)/avtcio.h $(srcdir)/akfavatar.h
	$(CC) $(CFLAGS) -I. -c -o $@ $(srcdir)/avtcwio.c

avatarsay.o: $(srcdir)/avatarsay.c $(srcdir)/akfavatar.h $(srcdir)/avtterm.h
	$(CC) $(SDLCFLAGS) $(CFLAGS) -DPREFIX=\"$(exec_prefix)\" -I. \
	  -c -o $@ $(srcdir)/avatarsay.c

avtterm.o: $(srcdir)/avtterm.c $(srcdir)/avtterm.h $(srcdir)/akfavatar.h
	$(CC) $(SDLCFLAGS) $(CFLAGS) -DPREFIX=\"$(exec_prefix)\" -I. \
	  -c -o $@ $(srcdir)/avtterm.c

avtmsg.o: $(srcdir)/avtmsg.c $(srcdir)/avtmsg.h
	$(CC) $(CFLAGS) -c -o $@ $(srcdir)/avtmsg.c

arch.o: $(srcdir)/arch.c $(srcdir)/arch.h
	$(CC) $(CFLAGS) -c -o $@ $(srcdir)/arch.c

libavtaddons.a: avtfilechooser.o avtterm.o arch.o \
                avtccio.o avtcwio.o avtmsg.o
	$(AR) rcu $@ avtfilechooser.o avtterm.o arch.o \
	             avtccio.o avtcwio.o avtmsg.o
	-$(RANLIB) $@

# avatarsay dynamically linked
# only works, when the library is installed
avatarsay-d: avatarsay.o libavtaddons.a libakfavatar.so
	$(CC) -o $@ avatarsay.o -L. -lavtaddons -lakfavatar \
	  $(LDFLAGS) $(AVATARSAY_LDFLAGS)

# avatarsay dynamically linked, with local rpath if possible
avatarsay: avatarsay.o libavtaddons.a libakfavatar.so
	$(CC) -o $@ avatarsay.o -L. -lavtaddons -lakfavatar \
	  $(LDFLAGS) $(AVATARSAY_LDFLAGS) $(LOCAL_GCC_RPATH)

# avatarsay with statical libakfavatar.a
avatarsay-s: avatarsay.o libavtaddons.a libakfavatar.a
	$(CC) -o $@ avatarsay.o -L. -lavtaddons libakfavatar.a \
	   $(SDLLDFLAGS) $(LDFLAGS) $(AVATARSAY_LDFLAGS)

installdirs:
	-[ -d $(DESTDIR)$(includedir) ]  || $(INSTALL) -d $(DESTDIR)$(includedir)
	-[ -d $(DESTDIR)$(libdir) ]      || $(INSTALL) -d $(DESTDIR)$(libdir)
	-[ -d $(DESTDIR)$(bindir) ]      || $(INSTALL) -d $(DESTDIR)$(bindir)
	-[ -d $(DESTDIR)$(infodir) ]     || $(INSTALL) -d $(DESTDIR)$(infodir)
	-[ -d $(DESTDIR)$(mandir) ]      || $(INSTALL) -d $(DESTDIR)$(mandir)
	-[ -d $(DESTDIR)$(mandir)/man1 ] || $(INSTALL) -d $(DESTDIR)$(mandir)/man1

install: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) $(srcdir)/akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(srcdir)/avtcio.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(LIBNAME) $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libavtcio.a $(DESTDIR)$(libdir)
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) $(srcdir)/avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/gnome-akfavatar $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/avtcmd $(DESTDIR)$(bindir)
	@echo '*'
	@echo '* make install-desktop-menu: to install avatarsay in a desktop menu'
	@echo '*'

install-strip: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) $(srcdir)/akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(srcdir)/avtcio.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) -s $(LIBNAME) $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libavtcio.a $(DESTDIR)$(libdir)
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) -s avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) $(srcdir)/avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/gnome-akfavatar $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) $(srcdir)/avtcmd $(DESTDIR)$(bindir)
	@echo '*'
	@echo '* use "make install-desktop-menu" to install avatarsay in a desktop menu'
	@echo '*'

install-desktop-menu: $(srcdir)/akfavatar.xpm $(srcdir)/akfoerster-avatarsay.desktop
	xdg-icon-resource install --size 32 --novendor $(srcdir)/akfavatar.xpm
	xdg-desktop-menu install $(srcdir)/akfoerster-avatarsay.desktop

uninstall: uninstall-info uninstall-man
	-rm -f $(includedir)/akfavatar.h
	-rm -f $(includedir)/avtcio.h
	-rm -f $(libdir)/$(LIBNAME)
	-rm -f $(libdir)/$(SONAME)
	-rm -f $(libdir)/libakfavatar.so
	-rm -f $(libdir)/libakfavatar.a
	-rm -f $(libdir)/libavtcio.a
	-rm -f $(bindir)/avatarsay
	-rm -f $(bindir)/avtman
	-rm -f $(bindir)/gnome-akfavatar
	-xdg-desktop-menu uninstall akfoerster-avatarsay.desktop
	-xdg-icon-resource uninstall --size 32 --novendor akfavatar.xpm

info:
	$(MAKE) -C $(srcdir)/doc info

install-info: info
	$(INSTALL_DATA) $(srcdir)/doc/akfavatar-en.info $(DESTDIR)$(infodir)
	$(INSTALL_DATA) $(srcdir)/doc/akfavatar-de.info $(DESTDIR)$(infodir)
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-en.info 
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-de.info 

uninstall-info:
	-install-info --remove --info-dir=$(DESTDIR)$(infodir) \
	  $(DESTDIR)$(infodir)/akfavatar-en.info 
	-rm -f $(DESTDIR)$(infodir)/akfavatar-en.info
	-install-info --remove --info-dir=$(DESTDIR)$(infodir) \
	  $(DESTDIR)$(infodir)/akfavatar-de.info 
	-rm -f $(DESTDIR)$(infodir)/akfavatar-de.info

install-man: man
	-$(INSTALL_DATA) $(srcdir)/doc/avatarsay.1 $(DESTDIR)$(mandir)/man1
	-$(INSTALL_DATA) $(srcdir)/doc/avtcmd.1 $(DESTDIR)$(mandir)/man1

uninstall-man:
	-rm -f $(DESTDIR)$(mandir)/man1/avatarsay.1 
	-rm -f $(DESTDIR)$(mandir)/man1/avtcmd.1

txt:
	$(MAKE) -C $(srcdir)/doc txt

html:
	$(MAKE) -C $(srcdir)/doc html

install-html:

dvi:
	$(MAKE) -C $(srcdir)/doc dvi

install-dvi:

pdf:
	$(MAKE) -C $(srcdir)/doc pdf

install-pdf:

ps:
	$(MAKE) -C $(srcdir)/doc ps

install-ps:

man:
	$(MAKE) -C $(srcdir)/doc man

doc:
	$(MAKE) -C $(srcdir)/doc all

check:

clean:
	-rm -f *~
	-rm -f *.o *.lo
	-rm -f *.ppu *.gpi *.gpm
	-rm -f bin2c
	-rm -f bdfread
	-rm -f bell.c
	-rm -f ucsfont9x18.c ucsfont7x14.c
	-rm -f pascal/*.o pascal/*.gpi pascal/*.gpm pascal/*.ppu
	-rm -f pascal/link.res pascal/ppas.sh
	$(MAKE) -C $(srcdir)/mingw clean
	$(MAKE) -C $(srcdir)/doc clean

mostlyclean: clean

distclean: clean
	-rm -f avatarsay avatarsay-d avatarsay-s
	-rm -f example a.out *.a *.so
	-rm -f $(LIBNAME) $(SONAME)
	-rm -f config.status
	-rm -f version.h
	-rm -f Makefile
	-rm -f $(srcdir)/pascal/example
	-rm -f akfavatar-*.tar.gz akfavatar-*.tar.bz2
	-rm -f multiply-bin multiply
	-rm -f multiplizieren-bin multiplizieren
	$(MAKE) -C $(srcdir)/mingw distclean
	$(MAKE) -C $(srcdir)/doc distclean


# the rest is just for the maintainer
# don't use it unless you know what you are doing

maintainer-clean: distclean
	@echo 'This command is intended for maintainers to use; it'
	@echo 'deletes files that may need special tools to rebuild.'
	rm -rf $(srcdir)/bell.au
	$(MAKE) -C $(srcdir)/doc maintainer-clean

maintainerclean: maintainer-clean

multiply: $(srcdir)/pascal/multiply.pas
	$(srcdir)/pascal/fpcavatar -dRELEASE -FE. -o$@ \
	    $(srcdir)/pascal/multiply.pas $(LOCAL_FPC_RPATH)

multiplizieren: $(srcdir)/pascal/multiply.pas
	$(srcdir)/pascal/fpcavatar -dRELEASE -ddeutsch -FE. -o$@ \
	    $(srcdir)/pascal/multiply.pas $(LOCAL_FPC_RPATH)

dist: info html man distclean
	mkdir $(PKGNAME)
	ln README INSTALL AUTHORS COPYING ChangeLog lrun \
	   avatar.c akfavatar.h avatar-audio.c avatar-default.c \
	   avtccio.c avtcwio.c avtcio.h avtfilechooser.c \
	   balloonpointer.xpm circle.xpm gnu-head.xpm \
	   male_user.xpm female_user.xpm \
	   btn.xpm btn-cont.xpm btn-no.xpm btn-yes.xpm \
	   avatarsay.c avtterm.h avtterm.c avtmsg.h avtmsg.c \
	   arch.h arch.c avtcolors.h \
	   avtman avtcmd example.c fsdemo-?? \
	   gnome-akfavatar akfoerster-avatarsay.desktop bdfread.c \
	   akfavatar.xpm info.xpm bin2c.c \
	   7x14.bdf 9x18.bdf font.c \
	   bell.flac bell.au \
	   configure Makefile.in \
	   $(PKGNAME)/
	
	mkdir $(PKGNAME)/pascal
	ln pascal/README pascal/akfavatar.pas pascal/example.pas \
	   pascal/multiply.pas pascal/positive.au pascal/negative.au \
	   pascal/neutral.au pascal/teacher.xpm \
	   pascal/gpcavatar pascal/fpcavatar \
	   $(PKGNAME)/pascal/
	
	mkdir $(PKGNAME)/doc
	ln doc/README doc/Makefile doc/avatarsay.1 doc/avtcmd.1 \
	   doc/akfavatar.h doc/pasref.txt \
	   doc/akfavatar-en.texinfo doc/akfavatar-en.info \
	   doc/akfavatar-en.html \
	   doc/akfavatar-de.texinfo doc/akfavatar-de.info \
	   doc/akfavatar-de.html \
	   doc/akfavatar.css \
	   doc/pdfmeta-en doc/pdfmeta-de \
	   $(PKGNAME)/doc/
	
	mkdir $(PKGNAME)/mingw
	ln mingw/akfavatar.ico mingw/icon.rc \
	   mingw/avtmsg.c mingw/avtwindows.c \
	   mingw/Makefile mingw/README \
	   mingw/fsdemo-??.bat \
	   $(PKGNAME)/mingw/
	
	tar -cvf $(PKGNAME).tar $(PKGNAME)/
	bzip2 $(PKGNAME).tar
	rm -rf $(PKGNAME)/

dist-bin: avatarsay multiply multiplizieren info html
	mkdir $(BINPKGNAME)
	cp $(LIBNAME) $(BINPKGNAME)/
	cp avatarsay $(BINPKGNAME)/
	ln $(SONAME) $(BINPKGNAME)/
	ln $(srcdir)/akfavatar.h $(srcdir)/pascal/akfavatar.pas $(BINPKGNAME)/
	ln $(srcdir)/pascal/?pcavatar $(BINPKGNAME)/
	ln $(srcdir)/gnu-head.xpm $(BINPKGNAME)/
	ln $(srcdir)/female_user.xpm $(BINPKGNAME)/
	-ln multiply $(BINPKGNAME)/
	-ln multiplizieren $(BINPKGNAME)/
	ln $(srcdir)/pascal/positive.au $(srcdir)/pascal/negative.au \
	   $(srcdir)/pascal/neutral.au $(srcdir)/pascal/teacher.xpm \
	   $(BINPKGNAME)/
	ln $(srcdir)/COPYING $(srcdir)/AUTHORS $(srcdir)/avtman \
	   $(srcdir)/fsdemo-?? \
	   $(srcdir)/gnome-akfavatar \
	   $(srcdir)/avtcmd \
	   $(BINPKGNAME)/
	ln $(srcdir)/doc/akfavatar-??.html $(BINPKGNAME)/
	ln $(srcdir)/doc/akfavatar-??.info $(BINPKGNAME)/
	strip $(BINPKGNAME)/avatarsay
	strip $(BINPKGNAME)/$(LIBNAME)
	tar -cvf $(BINPKGNAME).$(SYSTEM).$(ARCH).tar $(BINPKGNAME)/
	bzip2 $(BINPKGNAME).$(SYSTEM).$(ARCH).tar
	rm -rf $(BINPKGNAME)/
