# Makefile template for AKFAvatar
# Copyright (C) 2007 Andreas K. Foerster
#
# This Makefile template is free software; you have unlimited permission
# to copy, distribute and modify it.

SHELL = /bin/sh
INSTALL_PROGRAM = $(INSTALL) -m 755
INSTALL_DATA = $(INSTALL) -m 644

# native charset encoding (defaults to "WCHAR_T")
#ICONV_TARGET = -DICONV_TARGET=\"UCS-2\"

.PHONY: all check doc txt info install install-strip installdirs uninstall \
	html dvi pdf ps man install-html install-dvi install-pdf install-ps \
	clean mostlyclean distclean maintainerclean dist

all: libakfavatar.so libakfavatar.a avatarsay avatarsay-d

avatar.o: avatar.c akfavatar.h version.h balloonpointer.c circle.c regicon.c ucsfont7x14.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) $(ICONV_TARGET) -c $<

%.o: %.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -c -o $@ $<

libakfavatar.a: avatar.o avatar-default.o avatar-audio.o
	$(AR) rcu $@ avatar.o avatar-default.o avatar-audio.o
	-$(RANLIB) $@

avatar.lo: avatar.c akfavatar.h version.h balloonpointer.c circle.c regicon.c ucsfont7x14.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) $(ICONV_TARGET) -c -fpic -o $@ $<

%.lo: %.c
	$(CC) $(CFLAGS) $(SDLCFLAGS) -c -fpic -o $@ $<

libakfavatar.so: avatar.lo avatar-default.lo avatar-audio.lo
	$(CC) -shared \
	      -Wl,-soname,$(SONAME) -o $(LIBNAME) \
	      avatar.lo avatar-default.lo avatar-audio.lo \
	      $(LDFLAGS) $(SDLLDFLAGS)
	ln -sf $(LIBNAME) $(SONAME)
	ln -sf $(LIBNAME) libakfavatar.so

example: example.c libakfavatar.so
	$(CC) $(CFLAGS) -o $@ $< -L. -lakfavatar $(LDFLAGS)

# avatarsay dynamically linked
# only works, when the library is installed
avatarsay-d: avatarsay.c libakfavatar.so
	$(CC) $(CFLAGS) -o $@ $< -L. -lakfavatar $(LDFLAGS)

# avatarsay with statical libakfavatar.a
avatarsay: avatarsay.c libakfavatar.a
	$(CC) $(CFLAGS) $(SDLCFLAGS) -o $@ $< libakfavatar.a \
	  $(LDFLAGS) $(SDLLDFLAGS)

installdirs:
	-[ -d $(DESTDIR)$(includedir) ] || $(INSTALL) -d $(DESTDIR)$(includedir)
	-[ -d $(DESTDIR)$(libdir) ]     || $(INSTALL) -d $(DESTDIR)$(libdir)
	-[ -d $(DESTDIR)$(bindir) ]     || $(INSTALL) -d $(DESTDIR)$(bindir)
	-[ -d $(DESTDIR)$(infodir) ]    || $(INSTALL) -d $(DESTDIR)$(infodir)
	-[ -d $(DESTDIR)$(mandir) ]     || $(INSTALL) -d $(DESTDIR)$(mandir)
	-[ -d $(DESTDIR)$(mandir)/man1 ] || $(INSTALL) -d $(DESTDIR)$(mandir)/man1

install: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) $(LIBNAME) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) gnome-akfavatar $(DESTDIR)$(bindir)

install-strip: libakfavatar.so libakfavatar.a avatarsay-d installdirs install-info install-man
	$(INSTALL_DATA) akfavatar.h $(DESTDIR)$(includedir)
	$(INSTALL_DATA) -s $(LIBNAME) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) libakfavatar.a $(DESTDIR)$(libdir)
	-ln -sf $(LIBNAME) $(DESTDIR)$(libdir)/libakfavatar.so
	-$(LDCONFIG) $(libdir)
	$(INSTALL_PROGRAM) -s avatarsay-d $(DESTDIR)$(bindir)/avatarsay
	$(INSTALL_PROGRAM) avtman $(DESTDIR)$(bindir)
	$(INSTALL_PROGRAM) gnome-akfavatar $(DESTDIR)$(bindir)

uninstall: uninstall-info uninstall-man
	-rm -f $(includedir)/akfavatar.h
	-rm -f $(libdir)/$(LIBNAME)
	-rm -f $(libdir)/$(SONAME)
	-rm -f $(libdir)/libakfavatar.so
	-rm -f $(libdir)/libakfavatar.a
	-rm -f $(bindir)/avatarsay
	-rm -f $(bindir)/avtman
	-rm -f $(bindir)/gnome-akfavatar

info:
	$(MAKE) -C doc info

install-info: info
	$(INSTALL_DATA) doc/akfavatar-en.info $(DESTDIR)$(infodir)
	-install-info --info-dir=$(DESTDIR)$(infodir) \
	   $(DESTDIR)$(infodir)/akfavatar-en.info 

uninstall-info:
	-install-info --remove --info-dir=$(DESTDIR)$(infodir) \
	  $(DESTDIR)$(infodir)/akfavatar-en.info 
	-rm -f $(DESTDIR)$(infodir)/akfavatar-en.info

install-man:
	-$(INSTALL_DATA) doc/avatarsay.1 $(DESTDIR)$(mandir)/man1

uninstall-man:
	-rm -f $(DESTDIR)$(mandir)/man1/avatarsay.1

txt:
	$(MAKE) -C doc txt

html:
	$(MAKE) -C doc html

install-html:

dvi:
	$(MAKE) -C doc dvi

install-dvi:

pdf:
	$(MAKE) -C doc pdf

install-pdf:

ps:
	$(MAKE) -C doc ps

install-ps:

man:
	$(MAKE) -C doc man

doc:
	$(MAKE) -C doc all

check:

clean:
	-rm -f *~
	-rm -f *.o *.lo 
	-rm -f pascal/*.o pascal/*.gpi pascal/*.gpm pascal/*.ppu
	-rm -f pascal/link.res pascal/ppas.sh
	$(MAKE) -C mingw32 clean
	$(MAKE) -C doc clean

mostlyclean: clean

distclean: clean
	-rm -f avatarsay avatarsay-d example a.out *.a *.so
	-rm -f $(LIBNAME) $(SONAME)
	-rm -f config.status
	-rm -f version.h
	-rm -f Makefile
	-rm -f pascal/example
	-rm -f akfavatar-*.tar.gz
	-rm -f avatarsay-*.tar.gz
	$(MAKE) -C mingw32 distclean
	$(MAKE) -C doc distclean

maintainerclean: distclean

dist: info txt man distclean
	mkdir akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)
	ln README INSTALL AUTHORS COPYING \
	   avatar.c akfavatar.h avatar-audio.c avatar-default.c \
	   balloonpointer.c circle.c regicon.c gnu-head.bmp gnu-head.c \
	   ucsfont7x14.c avatarsay.c avtman example.c fsdemo-?? \
	   gnome-akfavatar bdfread.pas human-peasant.bmp \
	   gnu-small.bmp gnu-small.c akfavatar.xpm \
	   ucsfont4x6.c configure Makefile.in \
	   akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/
	
	mkdir akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/pascal
	ln pascal/README pascal/avatar.pas pascal/example.pas \
	   pascal/gpcavatar pascal/fpcavatar \
	   akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/pascal/
	
	mkdir akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/doc
	ln doc/README doc/Makefile doc/avatarsay.1 \
	   doc/akfavatar-en.texinfo doc/akfavatar-en.info \
	   doc/akfavatar-en.txt \
	   akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/doc/
	  
	mkdir akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/mingw32
	ln mingw32/akfavatar.ico mingw32/icon.rc \
	   mingw32/Makefile mingw32/README \
	   mingw32/fsdemo-??.bat \
	   akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/mingw32/
	
	tar -cvf akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).tar \
	    akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/
	gzip -9 akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).tar
	rm -r akfavatar-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/

dist-bin: avatarsay
	strip avatarsay
	mkdir avatarsay-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)
	ln COPYING AUTHORS avatarsay avtman fsdemo-?? \
	   gnome-akfavatar human-peasant.bmp \
	   avatarsay-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/
	tar -cvf avatarsay-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).bin.gnu-linux.x86.tar \
	    avatarsay-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/
	gzip -9 avatarsay-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT).bin.gnu-linux.x86.tar
	rm -r avatarsay-$(VERSION).$(SUBVERSION).$(REVISION)$(VARIANT)/
